@page "/calendar"
@using smart_journal.Models
@using smart_journal.Data
@using Microsoft.Maui.Controls @* Required for DisplayAlert *@
@inject AppDatabase Database
@inject NavigationManager Nav

<div class="calendar-wrapper">
    <div class="calendar-header">
        <button class="nav-btn" @onclick="PrevMonth">❮</button>
        <h2>@CurrentMonthName @CurrentYear</h2>
        <button class="nav-btn" @onclick="NextMonth">❯</button>
    </div>

    <div class="calendar-grid">
        @foreach (var dayName in DayNames)
        {
            <div class="day-name">@dayName</div>
        }

        @for (int i = 0; i < Offset; i++)
        {
            <div class="day-cell empty"></div>
        }

        @for (int d = 1; d <= DaysInMonth; d++)
        {
            var day = d;
            var date = new DateTime(CurrentYear, CurrentMonth, day);
            var hasEntry = EntryDates.Contains(date.Date);
            var isFuture = date.Date > DateTime.Today;
            var isPast = date.Date < DateTime.Today;
            var isToday = date.Date == DateTime.Today;

            var statusClass = isFuture ? "future-date"
            : (isToday && hasEntry) ? "today-done"
            : (isToday && !hasEntry) ? "today-pending"
            : (isPast && !hasEntry) ? "missed-date"
            : hasEntry ? "has-entry" : "";

            <div class="day-cell @statusClass" @onclick="() => HandleDateClick(date, isFuture, hasEntry, isPast)">
                <span class="day-number">@day</span>
                @if (hasEntry)
                {
                    <div class="entry-indicator"></div>
                }
                else if (isPast && !isFuture)
                {
                    <div class="missed-indicator">!</div>
                }
            </div>
        }
    </div>
</div>

@code {
    private DateTime DisplayDate = DateTime.Today;
    private List<DateTime> EntryDates = new();

    private int CurrentMonth => DisplayDate.Month;
    private int CurrentYear => DisplayDate.Year;
    private string CurrentMonthName => DisplayDate.ToString("MMMM");
    private int DaysInMonth => DateTime.DaysInMonth(CurrentYear, CurrentMonth);
    private int Offset => (int)new DateTime(CurrentYear, CurrentMonth, 1).DayOfWeek;
    private string[] DayNames = { "Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat" };

    protected override async Task OnInitializedAsync()
    {
        await LoadEntryDates();
    }

    private async Task LoadEntryDates()
    {
        var entries = await Database.GetEntriesAsync();
        EntryDates = entries.Select(e => e.Date.Date).ToList();
    }

    private async Task HandleDateClick(DateTime date, bool isFuture, bool hasEntry, bool isPast)
    {
        if (isFuture) return;

        if (hasEntry)
        {
            Nav.NavigateTo($"/journal/view/{date:yyyy-MM-dd}");
        }
        else if (isPast)
        {
            // Native MAUI System Dialog
            if (Application.Current?.MainPage != null)
            {
                await Application.Current.MainPage.DisplayAlert(
                    "Missed Entry",
                    $"There is no journal recorded for {date:MMM dd, yyyy}.",
                    "OK");
            }
        }
        else
        {
            Nav.NavigateTo($"/journal/edit/{date:yyyy-MM-dd}");
        }
    }

    private void NextMonth() => DisplayDate = DisplayDate.AddMonths(1);
    private void PrevMonth() => DisplayDate = DisplayDate.AddMonths(-1);
}