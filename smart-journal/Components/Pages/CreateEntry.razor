@page "/journal/edit/{DateString}"
@using smart_journal.Models
@using smart_journal.Data
@using Microsoft.Maui.Controls
@inject AppDatabase Database
@inject NavigationManager Nav
@inject IJSRuntime JS

<div class="entry-container">
    <div class="entry-header">
        <button type="button" class="btn-back" @onclick="GoBack">←</button>
        <input type="text" @bind="Entry.Title" placeholder="Entry Title..." class="title-input" />
        <button type="button" class="btn-save" @onclick="SaveEntry">Save Entry</button>
    </div>

    @* --- PRIMARY MOOD --- *@
    <div class="section-card">
        <label class="section-label">Primary Mood (Required)</label>
        <div class="mood-grid">
            @foreach (var m in PrimaryMoodOptions)
            {
                <button type="button" class="mood-pill @(Entry.PrimaryMood == m.Name ? "active" : "")"
                        @onclick="() => SetPrimaryMood(m)">
                    @m.Emoji @m.Name
                </button>
            }
        </div>
    </div>

    @* --- SECONDARY MOODS --- *@
    <div class="section-card">
        <label class="section-label">Secondary Feelings (Max 2)</label>
        <div class="mood-grid secondary">
            @foreach (var m in SecondaryMoodOptions)
            {
                bool isSelected = IsSecondarySelected(m.Name);
                <button type="button" class="mood-pill secondary @(isSelected ? "active-secondary" : "")"
                        @onclick="() => ToggleSecondaryMood(m.Name)">
                    @m.Emoji @m.Name
                </button>
            }
        </div>
    </div>

    @* --- TAGS --- *@
    <div class="section-card">
        <label class="section-label">Selected Tags (@GetTagCount() / 4)</label>
        <div class="tag-tray">
            @foreach (var tag in GetTagList())
            {
                <span class="selected-tag">
                    @tag
                    <i class="tag-close" @onclick="() => RemoveTag(tag)">×</i>
                </span>
            }
            @if (GetTagCount() < 4)
            {
                <input type="text" class="tag-inline-input" placeholder="Add tag..."
                       @bind="newTagInput" @bind:event="oninput" @onkeyup="HandleTagKeyUp" />
            }
        </div>

        <label class="section-label" style="margin-top: 15px; font-size: 0.7rem;">Suggestions</label>
        <div class="tag-suggestions">
            @foreach (var tag in Suggestions.Where(t => !IsTagSelected(t)).Take(8))
            {
                <button type="button" class="suggestion-pill" @onclick="() => AddTag(tag)">+ @tag</button>
            }
        </div>
    </div>

    @* --- EDITOR --- *@
    <div class="editor-wrapper" @key=' "quill-editor-parent" '>
        <div id="editor"></div>
    </div>
</div>

@code {
    [Parameter] public string DateString { get; set; }
    private JournalEntry Entry = new();
    private string newTagInput = "";

    private List<MoodItem> PrimaryMoodOptions = new() {
        new MoodItem("Happy", "😊", "Positive"),
        new MoodItem("Calm", "🌿", "Neutral"),
        new MoodItem("Sad", "😔", "Negative"),
        new MoodItem("Angry", "😡", "Negative")
    };

    private List<MoodItem> SecondaryMoodOptions = new() {
        new MoodItem("Anxious", "😟", "Negative"),
        new MoodItem("Grateful", "🙏", "Positive"),
        new MoodItem("Tired", "😴", "Neutral"),
        new MoodItem("Excited", "✨", "Positive"),
        new MoodItem("Lonely", "☁️", "Negative"),
        new MoodItem("Productive", "💪", "Positive")
    };

    private List<string> Suggestions = new() {
        "Work", "Family", "Health", "Hobbies", "Travel", "Self-care", "Exercise", "Music"
    };

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            if (DateTime.TryParse(DateString, out var date))
            {
                var existing = await Database.GetEntryByDateAsync(date.Date);

                // 1. Set the entry
                Entry = existing ?? new JournalEntry { Date = date.Date, Content = "", Tags = "" };

                // 2. Load the Quill Editor content
                await JS.InvokeVoidAsync("initializeQuill", Entry.Content);

                // 3. MANDATORY: Tell Blazor to refresh the UI with the loaded data!
                StateHasChanged();
            }
        }
    }

    private void SetPrimaryMood(MoodItem m)
    {
        Entry.PrimaryMood = m.Name;
        Entry.MoodCategory = m.Category; // Automatically sets Positive/Negative based on Model
    }

    // Logic to handle SecondaryMood1 and SecondaryMood2 fields in the Model
    private void ToggleSecondaryMood(string moodName)
    {
        if (Entry.SecondaryMood1 == moodName)
        {
            Entry.SecondaryMood1 = Entry.SecondaryMood2; // Shift slot 2 to slot 1
            Entry.SecondaryMood2 = null;
        }
        else if (Entry.SecondaryMood2 == moodName)
        {
            Entry.SecondaryMood2 = null;
        }
        else
        {
            if (string.IsNullOrEmpty(Entry.SecondaryMood1)) Entry.SecondaryMood1 = moodName;
            else if (string.IsNullOrEmpty(Entry.SecondaryMood2)) Entry.SecondaryMood2 = moodName;
        }
    }

    private bool IsSecondarySelected(string name) =>
        Entry.SecondaryMood1 == name || Entry.SecondaryMood2 == name;

    private void HandleTagKeyUp(KeyboardEventArgs e) { if (e.Key == "Enter" || e.Key == ",") AddTag(newTagInput); }

    private void AddTag(string tag)
    {
        var cleanTag = tag.Trim().Replace(",", "");
        if (string.IsNullOrWhiteSpace(cleanTag) || GetTagCount() >= 4) return;
        var tagList = GetTagList();
        if (!tagList.Contains(cleanTag))
        {
            tagList.Add(cleanTag);
            Entry.Tags = string.Join(",", tagList);
        }
        newTagInput = "";
    }

    private void RemoveTag(string tag)
    {
        var tagList = GetTagList();
        tagList.Remove(tag);
        Entry.Tags = string.Join(",", tagList);
    }

    private List<string> GetTagList() => string.IsNullOrEmpty(Entry.Tags) ? new List<string>() : Entry.Tags.Split(',').ToList();
    private int GetTagCount() => GetTagList().Count;
    private bool IsTagSelected(string tag) => GetTagList().Contains(tag);

    private async Task SaveEntry()
    {
        if (string.IsNullOrEmpty(Entry.PrimaryMood))
        {
            if (Application.Current?.MainPage != null)
                await Application.Current.MainPage.DisplayAlert("Required", "Please select a Primary Mood.", "OK");
            return;
        }

        Entry.Content = await JS.InvokeAsync<string>("getQuillContent");
        Entry.LastUpdated = DateTime.Now;

        await Database.SaveEntryAsync(Entry);
        Nav.NavigateTo("/calendar");
    }

    private void GoBack() => Nav.NavigateTo("/calendar");
    public record MoodItem(string Name, string Emoji, string Category);
}