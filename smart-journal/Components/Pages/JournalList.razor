@page "/journals"
@using smart_journal.Models
@using smart_journal.Data
@using QuestPDF.Fluent
@using QuestPDF.Helpers
@using QuestPDF.Infrastructure
@using CommunityToolkit.Maui.Storage
@using System.IO
@inject AppDatabase Database
@inject NavigationManager Nav

<div class="container-fluid p-2 p-md-4">
    @* --- HEADER --- *@
    <div class="d-flex justify-content-between align-items-center mb-4 px-2">
        <h2 class="fw-bold m-0 theme-text header-title">Journal History</h2>
        <div class="text-end">
            <span class="badge rounded-pill theme-badge">@FilteredEntries.Count Total</span>
        </div>
    </div>

    @* --- EXPORT SECTION --- *@
    <div class="card theme-card border-0 mb-4 rounded-3 shadow-sm">
        <div class="card-body p-3">
            <h6 class="fw-bold mb-3 theme-text">Export Journals to PDF</h6>
            <div class="row g-3 align-items-end">
                <div class="col-12 col-md-4">
                    <label class="small fw-bold theme-muted">From:</label>
                    <input type="date" class="form-control theme-input" @bind="StartDate" />
                </div>
                <div class="col-12 col-md-4">
                    <label class="small fw-bold theme-muted">To:</label>
                    <input type="date" class="form-control theme-input" @bind="EndDate" />
                </div>
                <div class="col-12 col-md-4">
                    <button class="btn btn-primary w-100 py-2" @onclick="ExportToPdf" disabled="@isExporting">
                        @if (isExporting)
                        {
                            <span class="spinner-border spinner-border-sm"></span>
                        }
                        else
                        {
                            <span>💾 Save PDF As...</span>
                        }
                    </button>
                </div>
            </div>
            @if (!string.IsNullOrEmpty(statusMessage))
            {
                <div class="small mt-2 fw-bold @(statusMessage.Contains("✅") ? "text-success" : "text-danger")">
                    @statusMessage
                </div>
            }
        </div>
    </div>

    @* --- SEARCH & FILTER SECTION --- *@
    <div class="card theme-card border-0 mb-4 rounded-3 shadow-sm">
        <div class="card-body p-3">
            <div class="row g-2">
                <div class="col-12 col-md-6">
                    <input type="text" class="form-control theme-input"
                           placeholder="Search your memories..."
                           @bind="searchTerm" @bind:event="oninput" @onkeyup="ApplyFilters" />
                </div>
                <div class="col-6 col-md-3">
                    <select class="form-select theme-input" @onchange="OnMoodFilterChanged">
                        <option value="">All Moods</option>
                        @foreach (var mood in UniqueMoods)
                        {
                            <option value="@mood">@mood</option>
                        }
                    </select>
                </div>
                <div class="col-6 col-md-3">
                    <button class="btn btn-outline-secondary w-100 theme-btn-outline" @onclick="ResetFilters">Reset</button>
                </div>
            </div>
        </div>
    </div>

    @* --- THE LIST --- *@
    <div class="journal-list-container">
        @if (!PaginatedEntries.Any())
        {
            <div class="text-center py-5 theme-card rounded shadow-sm">
                <p class="theme-muted mb-0">No entries found.</p>
            </div>
        }
        else
        {
            @foreach (var entry in PaginatedEntries)
            {
                <div class="card border-0 shadow-sm mb-3 journal-card theme-card" @onclick="() => ViewEntry(entry)">
                    <div class="card-body p-3 p-md-4">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1 overflow-hidden me-2">
                                <h5 class="fw-bold theme-text mb-1 text-truncate">@entry.Title</h5>
                                <p class="theme-muted small mb-0">@entry.Date.ToString("MMM dd, yyyy")</p>
                            </div>
                            <div class="d-flex align-items-center gap-1 gap-md-3">
                                <span class="badge theme-mood-badge small-badge">@entry.PrimaryMood</span>

                                @* --- ENHANCED RED DELETE BUTTON --- *@
                                <button class="btn-delete-action" title="Delete Entry" @onclick="() => ConfirmDelete(entry)" @onclick:stopPropagation="true">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-trash3-fill" viewBox="0 0 16 16">
                                        <path d="M11 1.5v1h3.5a.5.5 0 0 1 0 1h-.538l-.853 10.66A2 2 0 0 1 11.115 16h-6.23a2 2 0 0 1-1.994-1.84L2.038 3.5H1.5a.5.5 0 0 1 0-1H5v-1A1.5 1.5 0 0 1 6.5 0h3A1.5 1.5 0 0 1 11 1.5m-5 0v1h4v-1a.5.5 0 0 0-.5-.5h-3a.5.5 0 0 0-.5.5M4.5 5.029l.5 8.5a.5.5 0 1 0 .998-.06l-.5-8.5a.5.5 0 1 0-.998.06m6.53-.528a.5.5 0 0 0-.528.47l-.5 8.5a.5.5 0 0 0 .998.058l.5-8.5a.5.5 0 0 0-.47-.528M8 4.5a.5.5 0 0 0-.5.5v8.5a.5.5 0 0 0 1 0V5a.5.5 0 0 0-.5-.5" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <p class="theme-muted text-truncate-custom mt-2">@StripHtml(entry.Content)</p>
                    </div>
                </div>
            }
        }
    </div>

    @* --- PAGINATION --- *@
    @if (TotalPages > 0)
    {
        <div class="d-flex justify-content-center align-items-center gap-3 gap-md-4 mt-4 mb-5">
            <button class="btn btn-theme-round" disabled="@(currentPage == 1)" @onclick="PrevPage">❮</button>
            <span class="fw-bold theme-text small">Page @currentPage / @TotalPages</span>
            <button class="btn btn-theme-round" disabled="@(currentPage == TotalPages)" @onclick="NextPage">❯</button>
        </div>
    }
</div>

<style>
    /* Dark Mode Core */
    .theme-text {
        color: var(--text-primary);
    }

    .theme-muted {
        color: var(--text-muted);
    }

    .theme-card {
        background-color: var(--bg-card);
        color: var(--text-primary);
        border: 1px solid var(--border-color) !important;
    }

    .theme-input {
        background-color: var(--bg-main);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
    }

    .theme-badge {
        background-color: var(--primary-green);
        color: #fff;
    }

    .theme-mood-badge {
        background-color: var(--accent-light);
        color: var(--primary-green);
        border: 1px solid var(--primary-green);
    }

    /* Interactive Elements */
    .journal-card {
        cursor: pointer;
        transition: 0.2s ease;
        border-left: 5px solid transparent !important;
        border-radius: 12px;
    }

        .journal-card:hover {
            transform: translateX(5px);
            border-left: 5px solid var(--primary-green) !important;
            background-color: var(--accent-light);
        }

    /* RED DELETE ICON STYLES */
    .btn-delete-action {
        background: transparent;
        border: none;
        color: #ff4d4d; /* Muted red for readability without being overwhelming */
        padding: 8px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
    }

        .btn-delete-action:hover {
            background-color: rgba(255, 77, 77, 0.15);
            color: #ff0000; /* Bright red on hover */
            transform: scale(1.1);
        }

        .btn-delete-action:active {
            transform: scale(0.95);
        }

    .btn-theme-round {
        width: 38px;
        height: 38px;
        border-radius: 50%;
        background-color: var(--bg-card);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* Custom Truncate for long content */
    .text-truncate-custom {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        font-size: 0.9rem;
    }

    /* RESPONSIVE */
    @@media (max-width: 768px) {
        .header-title {
            font-size: 1.5rem;
        }

        .journal-card:hover {
            transform: none;
        }

        .small-badge {
            font-size: 0.75rem;
            padding: 0.4em 0.6em;
        }
    }
</style>

@code {
    // ... C# Logic remains identical to previous version ...
    private List<JournalEntry> AllEntries = new();
    private List<JournalEntry> FilteredEntries = new();
    private List<string> UniqueMoods = new();
    private string searchTerm = "";
    private string selectedMood = "";
    private int currentPage = 1;
    private int pageSize = 8;
    private DateTime StartDate { get; set; } = DateTime.Today.AddMonths(-1);
    private DateTime EndDate { get; set; } = DateTime.Today;
    private bool isExporting = false;
    private string statusMessage = "";

    protected override async Task OnInitializedAsync()
    {
        QuestPDF.Settings.License = LicenseType.Community;
        await LoadData();
    }

    private async Task LoadData()
    {
        var data = await Database.GetEntriesAsync();
        AllEntries = data.OrderByDescending(e => e.Date).ToList();
        UniqueMoods = AllEntries.Where(e => !string.IsNullOrEmpty(e.PrimaryMood)).Select(e => e.PrimaryMood).Distinct().ToList();
        ApplyFilters();
    }

    private void ApplyFilters()
    {
        FilteredEntries = AllEntries
            .Where(e => (string.IsNullOrWhiteSpace(searchTerm) ||
                         (e.Title?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false) ||
                         (e.Content?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false)) &&
                        (string.IsNullOrEmpty(selectedMood) || e.PrimaryMood == selectedMood))
            .ToList();
        if (currentPage > TotalPages && TotalPages > 0) currentPage = 1;
    }

    private async Task ConfirmDelete(JournalEntry entry)
    {
        bool confirm = await Application.Current.MainPage.DisplayAlert(
            "Delete Entry?",
            $"Are you sure you want to delete '{entry.Title}'? This cannot be undone.",
            "Delete",
            "Cancel");

        if (confirm)
        {
            await Database.DeleteEntryAsync(entry);
            await LoadData();
        }
    }

    private async Task ExportToPdf()
    {
        if (isExporting) return;
        isExporting = true;
        statusMessage = "";
        try
        {
            var entriesToExport = AllEntries.Where(e => e.Date.Date >= StartDate.Date && e.Date.Date <= EndDate.Date).OrderBy(e => e.Date).ToList();
            if (!entriesToExport.Any()) { statusMessage = "⚠️ No entries found."; return; }
            var document = Document.Create(container =>
            {
                container.Page(page =>
                {
                    page.Margin(40);
                    page.Header().PaddingBottom(20).Text("My Journal History").FontSize(24).Bold().FontColor("#2d6a4f");
                    page.Content().Column(col =>
                    {
                        foreach (var entry in entriesToExport)
                        {
                            col.Item().PaddingBottom(15).BorderBottom(1).BorderColor("#eee").PaddingBottom(5).Column(c =>
                            {
                                c.Item().Text(entry.Title).Bold();
                                c.Item().Text(StripHtml(entry.Content)).FontSize(10);
                            });
                        }
                    });
                });
            });
            using var stream = new MemoryStream(document.GeneratePdf());
            await FileSaver.Default.SaveAsync($"Export_{DateTime.Now:yyyyMMdd}.pdf", stream, default);
            statusMessage = "✅ PDF Saved Successfully!";
        }
        catch (Exception ex) { statusMessage = "❌ Error: " + ex.Message; }
        finally { isExporting = false; StateHasChanged(); }
    }

    private IEnumerable<JournalEntry> PaginatedEntries => FilteredEntries.Skip((currentPage - 1) * pageSize).Take(pageSize);
    private int TotalPages => (int)Math.Ceiling((double)FilteredEntries.Count / pageSize);
    private void NextPage() { if (currentPage < TotalPages) currentPage++; }
    private void PrevPage() { if (currentPage > 1) currentPage--; }
    private void OnMoodFilterChanged(ChangeEventArgs e) { selectedMood = e.Value?.ToString() ?? ""; currentPage = 1; ApplyFilters(); }
    private void ResetFilters() { searchTerm = ""; selectedMood = ""; currentPage = 1; ApplyFilters(); }
    private void ViewEntry(JournalEntry entry) => Nav.NavigateTo($"/journal/view/{entry.Date:yyyy-MM-dd}");
    private string StripHtml(string html)
    {
        if (string.IsNullOrEmpty(html)) return "";
        var formatted = System.Text.RegularExpressions.Regex.Replace(html, "<(p|br|li|div).*?>", " ", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        return System.Net.WebUtility.HtmlDecode(System.Text.RegularExpressions.Regex.Replace(formatted, "<.*?>", string.Empty)).Trim();
    }
}