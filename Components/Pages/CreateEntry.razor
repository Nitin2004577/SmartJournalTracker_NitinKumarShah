@page "/journal/edit/{DateString}"
@using smart_journal.Models
@using smart_journal.Data
@inject AppDatabase Database
@inject NavigationManager Nav
@inject IJSRuntime JS

<div class="entry-container">
    <div class="entry-header">
        <button type="button" class="btn-back" @onclick="GoBack">←</button>
        <input type="text" @bind="Entry.Title" placeholder="Entry Title..." class="title-input" />
        <button type="button" class="btn-save" @onclick="SaveEntry">Save Entry</button>
    </div>

    <div class="section-card">
        <label class="section-label">Primary Mood</label>
        <div class="mood-grid">
            @foreach (var m in AllMoods)
            {
                <button type="button" class="mood-pill @(Entry.PrimaryMood == m.Name ? "active" : "")"
                        @onclick="() => Entry.PrimaryMood = m.Name">
                    @m.Emoji @m.Name
                </button>
            }
        </div>
    </div>

    <div class="editor-wrapper" @key=' "quill-editor-parent" '>
        <div id="editor"></div>
    </div>
</div>

@code {
    [Parameter] public string DateString { get; set; }
    private JournalEntry Entry = new();
    private bool isInitialized = false;

    private List<MoodItem> AllMoods = new() {
        new MoodItem("Happy", "😊", "Positive"),
        new MoodItem("Calm", "🌿", "Neutral"),
        new MoodItem("Sad", "😔", "Negative"),
        new MoodItem("Angry", "😡", "Negative"),
        new MoodItem("Excited", "🎉", "Positive")
    };

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !isInitialized)
        {
            isInitialized = true;
            if (DateTime.TryParse(DateString, out var date))
            {
                var existing = await Database.GetEntryByDateAsync(date.Date);
                Entry = existing ?? new JournalEntry { Date = date.Date, Content = "" };

                // Load Quill and pass existing content
                await JS.InvokeVoidAsync("initializeQuill", Entry.Content);
            }
        }
    }

    private async Task SaveEntry()
    {
        // Ask JS for the content ONLY when saving
        Entry.Content = await JS.InvokeAsync<string>("getQuillContent");
        await Database.SaveEntryAsync(Entry);
        Nav.NavigateTo("/");
    }

    private void GoBack() => Nav.NavigateTo("/");
    public record MoodItem(string Name, string Emoji, string Category);
}