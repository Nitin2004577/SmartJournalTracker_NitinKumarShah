@page "/"
@using smart_journal.Models
@using smart_journal.Data
@inject AppDatabase Database

<div class="container-fluid p-4">
    <h2 class="fw-bold mb-4 theme-text">Insights & Analytics</h2>

    @* --- STREAK STATS CARDS --- *@
    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="card border-0 shadow-sm dashboard-card-primary p-3 text-center">
                <h6 class="text-uppercase small opacity-75">Current Streak</h6>
                <h2 class="fw-bold m-0">🔥 @CurrentStreak Days</h2>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm dashboard-card-dark p-3 text-center">
                <h6 class="text-uppercase small opacity-75">Longest Streak</h6>
                <h2 class="fw-bold m-0">🏆 @LongestStreak Days</h2>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm theme-card p-3 text-center">
                <h6 class="text-uppercase small theme-muted">Missed Days (Month)</h6>
                <h2 class="fw-bold m-0 text-danger">📉 @MissedDays</h2>
            </div>
        </div>
    </div>

    <div class="row g-4">
        @* --- MOOD DISTRIBUTION --- *@
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm h-100 theme-card">
                <div class="card-body">
                    <h5 class="fw-bold mb-3 theme-text">Mood Distribution</h5>
                    @if (!MoodCounts.Any())
                    {
                        <p class="theme-muted">Write more entries to see mood trends.</p>
                    }
                    @foreach (var mood in MoodCounts.OrderByDescending(m => m.Value))
                    {
                        var percentage = (double)mood.Value / TotalEntries * 100;
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span class="theme-text">@mood.Key</span>
                                <span class="fw-bold theme-text">@mood.Value</span>
                            </div>
                            <div class="progress theme-progress" style="height: 10px;">
                                <div class="progress-bar theme-progress-bar" style="width: @($"{percentage}%")"></div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>

        @* --- TAG BREAKDOWN --- *@
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm h-100 theme-card">
                <div class="card-body">
                    <h5 class="fw-bold mb-3 theme-text">Most Used Tags</h5>
                    <div class="d-flex flex-wrap gap-2">
                        @if (!TagCounts.Any())
                        {
                            <p class="theme-muted">No tags found.</p>
                        }
                        @foreach (var tag in TagCounts.OrderByDescending(t => t.Value).Take(15))
                        {
                            <span class="badge theme-tag-badge p-2">
                                #@tag.Key <span class="ms-1 theme-primary-text">(@tag.Value)</span>
                            </span>
                        }
                    </div>
                </div>
            </div>
        </div>

        @* --- WORD COUNT TRENDS --- *@
        <div class="col-12">
            <div class="card border-0 shadow-sm theme-card">
                <div class="card-body">
                    <h5 class="fw-bold mb-3 theme-text">Writing Volume (Word Count)</h5>
                    <div class="table-responsive">
                        <table class="table table-sm theme-table">
                            <thead>
                                <tr class="theme-text">
                                    <th>Date</th>
                                    <th>Title</th>
                                    <th>Words</th>
                                    <th>Volume</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var entry in AllEntries.Take(7))
                                {
                                    <tr class="theme-text border-theme">
                                        <td>@entry.Date.ToString("MMM dd")</td>
                                        <td class="text-truncate" style="max-width: 150px;">@entry.Title</td>
                                        <td>@GetWordCount(entry.Content)</td>
                                        <td class="w-25">
                                            <div class="progress theme-progress" style="height: 6px; margin-top: 8px;">
                                                <div class="progress-bar theme-progress-bar"
                                                     style="width: @(Math.Min(GetWordCount(entry.Content) / 5, 100))%"></div>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Helper Classes for the Theme */
    .theme-text {
        color: var(--text-primary);
    }

    .theme-muted {
        color: var(--text-muted);
    }

    .theme-card {
        background-color: var(--bg-card);
        border: 1px solid var(--border-color) !important;
    }

    .theme-primary-text {
        color: var(--primary-green);
    }

    /* Streak Card Variations */
    .dashboard-card-primary {
        background-color: var(--primary-green);
        color: #ffffff;
    }

    .dashboard-card-dark {
        background-color: var(--bg-sidebar);
        color: var(--text-primary);
        border: 1px solid var(--border-color) !important;
    }

    /* Progress Bars */
    .theme-progress {
        background-color: var(--bg-main);
        overflow: hidden;
    }

    .theme-progress-bar {
        background-color: var(--primary-green);
    }

    /* Tags */
    .theme-tag-badge {
        background-color: var(--bg-main);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
        font-weight: 500;
    }

    /* Table Styles */
    .theme-table {
        color: var(--text-primary);
    }

    .border-theme {
        border-bottom: 1px solid var(--border-color);
    }

    .text-truncate {
        display: -webkit-box;
        -webkit-line-clamp: 1;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
</style>

@code {
    // ... [Keep your existing @code block exactly as it is]
    private List<JournalEntry> AllEntries = new();
    private Dictionary<string, int> MoodCounts = new();
    private Dictionary<string, int> TagCounts = new();
    private int TotalEntries;
    private int CurrentStreak;
    private int LongestStreak;
    private int MissedDays;

    protected override async Task OnInitializedAsync()
    {
        var data = await Database.GetEntriesAsync();
        AllEntries = data.OrderByDescending(e => e.Date).ToList();
        TotalEntries = AllEntries.Count;

        CalculateMoods();
        CalculateTags();
        CalculateStreaks();
    }

    private void CalculateMoods()
    {
        MoodCounts = AllEntries
            .Where(e => !string.IsNullOrEmpty(e.PrimaryMood))
            .GroupBy(e => e.PrimaryMood)
            .ToDictionary(g => g.Key, g => g.Count());
    }

    private void CalculateTags()
    {
        var allTags = AllEntries
            .Where(e => !string.IsNullOrEmpty(e.Tags))
            .SelectMany(e => e.Tags.Split(',', StringSplitOptions.RemoveEmptyEntries))
            .Select(t => t.Trim());

        TagCounts = allTags
            .GroupBy(t => t)
            .ToDictionary(g => g.Key, g => g.Count());
    }

    private void CalculateStreaks()
    {
        if (!AllEntries.Any()) return;

        var dates = AllEntries.Select(e => e.Date.Date).Distinct().OrderByDescending(d => d).ToList();
        DateTime today = DateTime.Today;

        int current = 0;
        DateTime checkDate = dates.Contains(today) ? today : today.AddDays(-1);

        while (dates.Contains(checkDate))
        {
            current++;
            checkDate = checkDate.AddDays(-1);
        }
        CurrentStreak = current;

        int longest = 0;
        int tempLongest = 0;
        var sortedAsc = dates.OrderBy(d => d).ToList();

        for (int i = 0; i < sortedAsc.Count; i++)
        {
            tempLongest++;
            if (i == sortedAsc.Count - 1 || sortedAsc[i + 1] != sortedAsc[i].AddDays(1))
            {
                if (tempLongest > longest) longest = tempLongest;
                tempLongest = 0;
            }
        }
        LongestStreak = longest;

        int entryCountLast30 = dates.Count(d => d >= today.AddDays(-30));
        MissedDays = 30 - entryCountLast30;
    }

    private int GetWordCount(string html)
    {
        if (string.IsNullOrEmpty(html)) return 0;
        string formattedText = System.Text.RegularExpressions.Regex.Replace(html, "<(p|br|li|div|h1|h2|h3|ol|ul).*?>", " ", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        var plainText = System.Text.RegularExpressions.Regex.Replace(formattedText, "<.*?>", string.Empty);
        plainText = System.Net.WebUtility.HtmlDecode(plainText);
        return plainText.Split(new[] { ' ', '\t', '\r', '\n' }, StringSplitOptions.RemoveEmptyEntries).Length;
    }
}