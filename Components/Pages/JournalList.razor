@page "/journals"
@using smart_journal.Models
@using smart_journal.Data
@using QuestPDF.Fluent
@using QuestPDF.Helpers
@using QuestPDF.Infrastructure
@using CommunityToolkit.Maui.Storage
@using System.IO
@inject AppDatabase Database
@inject NavigationManager Nav

<div class="container-fluid p-4">
    @* --- HEADER --- *@
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold m-0">Journal History</h2>
        <div class="text-end">
            <span class="badge bg-primary rounded-pill">@FilteredEntries.Count Total</span>
        </div>
    </div>

    @* --- EXPORT SECTION (Date Range) --- *@
    <div class="card shadow-sm border-0 mb-4 bg-light rounded-3">
        <div class="card-body p-3">
            <h6 class="fw-bold mb-3">Export Journals to PDF</h6>
            <div class="row g-2 align-items-end">
                <div class="col-md-4">
                    <label class="small fw-bold">From:</label>
                    <input type="date" class="form-control form-control-sm" @bind="StartDate" />
                </div>
                <div class="col-md-4">
                    <label class="small fw-bold">To:</label>
                    <input type="date" class="form-control form-control-sm" @bind="EndDate" />
                </div>
                <div class="col-md-4">
                    <button class="btn btn-primary btn-sm w-100" @onclick="ExportToPdf" disabled="@isExporting">
                        @if (isExporting)
                        {
                            <span class="spinner-border spinner-border-sm"></span>
                        }
                        else
                        {
                            <span>💾 Save PDF As...</span>
                        }
                    </button>
                </div>
            </div>
            @if (!string.IsNullOrEmpty(statusMessage))
            {
                <div class="small mt-2 text-success fw-bold">@statusMessage</div>
            }
        </div>
    </div>

    @* --- SEARCH & FILTER SECTION --- *@
    <div class="card shadow-sm border-0 mb-4 bg-white rounded-3">
        <div class="card-body p-3">
            <div class="row g-2">
                <div class="col-md-6">
                    <input type="text" class="form-control border-light bg-light" 
                           placeholder="Search your memories..." 
                           @bind="searchTerm" @bind:event="oninput" @onkeyup="ApplyFilters" />
                </div>
                <div class="col-md-3">
                    <select class="form-select border-light bg-light" @onchange="OnMoodFilterChanged">
                        <option value="">All Moods</option>
                        @foreach (var mood in UniqueMoods)
                        {
                            <option value="@mood">@mood</option>
                        }
                    </select>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-outline-secondary w-100" @onclick="ResetFilters">Reset Filters</button>
                </div>
            </div>
        </div>
    </div>

    @* --- THE PAGINATED LIST --- *@
    <div class="journal-list-container">
        @if (!PaginatedEntries.Any())
        {
            <div class="text-center py-5 bg-white rounded shadow-sm">
                <p class="text-muted mb-0">No entries found for this page or filter.</p>
            </div>
        }
        else
        {
            @foreach (var entry in PaginatedEntries)
            {
                <div class="card border-0 shadow-sm mb-3 journal-card" @onclick="() => ViewEntry(entry)">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h5 class="fw-bold text-dark mb-1">@entry.Title</h5>
                                <p class="text-muted small mb-2">@entry.Date.ToString("MMMM dd, yyyy")</p>
                            </div>
                            <span class="badge bg-info text-dark">@entry.PrimaryMood</span>
                        </div>
                        <p class="text-secondary text-truncate">@StripHtml(entry.Content)</p>
                    </div>
                </div>
            }
        }
    </div>

    @* --- PAGINATION --- *@
    @if (TotalPages > 0)
    {
        <div class="d-flex justify-content-center align-items-center gap-4 mt-4">
            <button class="btn btn-dark rounded-circle" 
                    disabled="@(currentPage == 1)" 
                    @onclick="PrevPage" 
                    style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                ❮
            </button>
            <span class="fw-bold">Page @currentPage of @TotalPages</span>
            <button class="btn btn-dark rounded-circle" 
                    disabled="@(currentPage == TotalPages)" 
                    @onclick="NextPage"
                    style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                ❯
            </button>
        </div>
    }
</div>

<style>
    .journal-card { cursor: pointer; transition: transform 0.2s; border-left: 4px solid transparent; }
    .journal-card:hover { transform: translateX(5px); box-shadow: 0 4px 15px rgba(0,0,0,0.1) !important; border-left: 4px solid #0d6efd; }
    .text-truncate { display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical; overflow: hidden; }
</style>

@code {
    private List<JournalEntry> AllEntries = new();
    private List<JournalEntry> FilteredEntries = new();
    private List<string> UniqueMoods = new();
    private string searchTerm = "";
    private string selectedMood = "";
    private int currentPage = 1;
    private int pageSize = 8; 

    // Export Variables
    private DateTime StartDate { get; set; } = DateTime.Today.AddMonths(-1);
    private DateTime EndDate { get; set; } = DateTime.Today;
    private bool isExporting = false;
    private string statusMessage = "";

    protected override async Task OnInitializedAsync()
    {
        QuestPDF.Settings.License = LicenseType.Community;
        await LoadData();
    }

    private async Task LoadData()
    {
        var data = await Database.GetEntriesAsync();
        AllEntries = data.OrderByDescending(e => e.Date).ToList();
        UniqueMoods = AllEntries.Where(e => !string.IsNullOrEmpty(e.PrimaryMood)).Select(e => e.PrimaryMood).Distinct().ToList();
        ApplyFilters();
    }

    private void ApplyFilters()
    {
        FilteredEntries = AllEntries
            .Where(e => (string.IsNullOrWhiteSpace(searchTerm) || 
                         (e.Title?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false) || 
                         (e.Content?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false)) &&
                        (string.IsNullOrEmpty(selectedMood) || e.PrimaryMood == selectedMood))
            .ToList();
        if (currentPage > TotalPages && TotalPages > 0) currentPage = 1;
    }

    private async Task ExportToPdf()
    {
        if (isExporting) return;
        isExporting = true;
        statusMessage = "";

        try
        {
            var entriesToExport = AllEntries
                .Where(e => e.Date.Date >= StartDate.Date && e.Date.Date <= EndDate.Date)
                .OrderBy(e => e.Date)
                .ToList();

            if (!entriesToExport.Any()) return;

            var document = Document.Create(container =>
            {
                container.Page(page =>
                {
                    page.Margin(40);
                    page.Header().PaddingBottom(20).Text("My Journal History").FontSize(28).Bold().FontColor("#2563eb");

                    page.Content().Column(col =>
                    {
                        foreach (var entry in entriesToExport)
                        {
                            col.Item().PaddingBottom(20).Decoration(decoration =>
                            {
                                decoration.Content().Border(1).BorderColor(Colors.Grey.Lighten2).Padding(15).Column(entryCol =>
                                {
                                    // HEADER ROW: Date Display
                                    entryCol.Item().Row(row =>
                                    {
                                        row.RelativeItem().Column(dateCol =>
                                        {
                                            dateCol.Item().Text(entry.Date.Day.ToString()).FontSize(22).Bold();
                                            dateCol.Item().Text($"{entry.Date:MMMM} {entry.Date.Year}").FontSize(10).FontColor(Colors.Grey.Medium);
                                        });

                                        row.RelativeItem().AlignRight().Text(entry.PrimaryMood).Italic().FontColor("#0d6efd");
                                    });

                                    entryCol.Item().PaddingVertical(10).LineHorizontal(0.5f).LineColor(Colors.Grey.Lighten3);

                                    // TITLE
                                    entryCol.Item().PaddingBottom(5).Text(entry.Title).FontSize(16).Bold();

                                    // PILLS (Moods and Tags)
                                    entryCol.Item().PaddingBottom(10).Row(row =>
                                    {
                                        row.Spacing(5);

                                        // Primary Mood Pill
                                        row.ConstantItem(60).Background("#e1f5fe").PaddingHorizontal(5).AlignCenter().Text(entry.PrimaryMood).FontSize(8).FontColor("#0288d1");

                                        // Secondary Moods
                                        if (!string.IsNullOrEmpty(entry.SecondaryMood1))
                                            row.ConstantItem(60).Background("#f5f5f5").PaddingHorizontal(5).AlignCenter().Text(entry.SecondaryMood1).FontSize(8);

                                        if (!string.IsNullOrEmpty(entry.SecondaryMood2))
                                            row.ConstantItem(60).Background("#f5f5f5").PaddingHorizontal(5).AlignCenter().Text(entry.SecondaryMood2).FontSize(8);

                                        // Tags (split and show first 3)
                                        if (!string.IsNullOrEmpty(entry.Tags))
                                        {
                                            foreach (var tag in entry.Tags.Split(',', StringSplitOptions.RemoveEmptyEntries).Take(3))
                                            {
                                                row.ConstantItem(50).Border(0.5f).BorderColor(Colors.Grey.Lighten2).PaddingHorizontal(5).AlignCenter().Text($"#{tag.Trim()}").FontSize(7);
                                            }
                                        }
                                    });

                                    // CONTENT AREA
                                    entryCol.Item().Text(StripHtml(entry.Content)).FontSize(11).LineHeight(1.4f);
                                });
                            });
                        }
                    });

                    page.Footer().AlignCenter().Text(x => { x.Span("Page "); x.CurrentPageNumber(); });
                });
            });

            var pdfBytes = document.GeneratePdf();
            using var stream = new MemoryStream(pdfBytes);
            var fileName = $"Journal_Export_{DateTime.Now:yyyyMMdd}.pdf";

            var fileSaveResult = await FileSaver.Default.SaveAsync(fileName, stream, default);

            if (fileSaveResult.IsSuccessful)
            {
                statusMessage = "✅ Export Successful!";
            }
        }
        catch (Exception ex)
        {
            statusMessage = "❌ Error: " + ex.Message;
        }
        finally
        {
            isExporting = false;
            StateHasChanged();
        }
    }

    private IEnumerable<JournalEntry> PaginatedEntries => FilteredEntries.Skip((currentPage - 1) * pageSize).Take(pageSize);
    private int TotalPages => (int)Math.Ceiling((double)FilteredEntries.Count / pageSize);
    private void NextPage() { if (currentPage < TotalPages) currentPage++; }
    private void PrevPage() { if (currentPage > 1) currentPage--; }
    private void OnMoodFilterChanged(ChangeEventArgs e) { selectedMood = e.Value?.ToString() ?? ""; currentPage = 1; ApplyFilters(); }
    private void ResetFilters() { searchTerm = ""; selectedMood = ""; currentPage = 1; ApplyFilters(); }
    private void ViewEntry(JournalEntry entry) => Nav.NavigateTo($"/journal/view/{entry.Date:yyyy-MM-dd}");

    private string StripHtml(string html)
    {
        if (string.IsNullOrEmpty(html)) return "";
        // Replace block tags with spaces to avoid word mashing
        var formatted = System.Text.RegularExpressions.Regex.Replace(html, "<(p|br|li|div).*?>", " ", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        return System.Net.WebUtility.HtmlDecode(System.Text.RegularExpressions.Regex.Replace(formatted, "<.*?>", string.Empty)).Trim();
    }
}