@page "/journals"
@using smart_journal.Models
@using smart_journal.Data
@inject AppDatabase Database
@inject NavigationManager Nav

<div class="container-fluid p-4">
    @* --- HEADER --- *@
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold m-0">Journal History</h2>
        <div class="text-end">
            <span class="badge bg-primary rounded-pill">@FilteredEntries.Count Total</span>
        </div>
    </div>

    @* --- SEARCH & FILTER SECTION --- *@
    <div class="card shadow-sm border-0 mb-4 bg-white rounded-3">
        <div class="card-body p-3">
            <div class="row g-2">
                <div class="col-md-6">
                    <input type="text" class="form-control border-light bg-light" 
                           placeholder="Search your memories..." 
                           @bind="searchTerm" @bind:event="oninput" @onkeyup="ApplyFilters" />
                </div>
                <div class="col-md-3">
                    <select class="form-select border-light bg-light" @onchange="OnMoodFilterChanged">
                        <option value="">All Moods</option>
                        @foreach (var mood in UniqueMoods)
                        {
                            <option value="@mood">@mood</option>
                        }
                    </select>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-outline-secondary w-100" @onclick="ResetFilters">Reset Filters</button>
                </div>
            </div>
        </div>
    </div>

    @* --- THE PAGINATED LIST --- *@
    <div class="journal-list-container">
        @if (!PaginatedEntries.Any())
        {
            <div class="text-center py-5 bg-white rounded shadow-sm">
                <p class="text-muted mb-0">No entries found for this page or filter.</p>
            </div>
        }
        else
        {
            @foreach (var entry in PaginatedEntries)
            {
                <div class="card border-0 shadow-sm mb-3 journal-card" @onclick="() => ViewEntry(entry)">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h5 class="fw-bold text-dark mb-1">@entry.Title</h5>
                                <p class="text-muted small mb-2">@entry.Date.ToString("MMMM dd, yyyy")</p>
                            </div>
                            <span class="badge bg-info text-dark">@entry.PrimaryMood</span>
                        </div>
                        <p class="text-secondary text-truncate">@StripHtml(entry.Content)</p>
                    </div>
                </div>
            }
        }
    </div>

    @* --- PAGINATION NAVIGATION (Page X of Y) --- *@
    @if (TotalPages > 0)
    {
        <div class="d-flex justify-content-center align-items-center gap-4 mt-4">
            <button class="btn btn-dark rounded-circle" 
                    disabled="@(currentPage == 1)" 
                    @onclick="PrevPage" 
                    style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                ❮
            </button>

            <span class="fw-bold">
                Page @currentPage of @TotalPages
            </span>

            <button class="btn btn-dark rounded-circle" 
                    disabled="@(currentPage == TotalPages)" 
                    @onclick="NextPage"
                    style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                ❯
            </button>
        </div>
    }
</div>

<style>
    .journal-card {
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
        border-left: 4px solid transparent;
    }
    .journal-card:hover {
        transform: translateX(5px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.1) !important;
        border-left: 4px solid #0d6efd;
    }
    .text-truncate {
        display: -webkit-box;
        -webkit-line-clamp: 1;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
</style>

@code {
    private List<JournalEntry> AllEntries = new();
    private List<JournalEntry> FilteredEntries = new();
    private List<string> UniqueMoods = new();

    private string searchTerm = "";
    private string selectedMood = "";
    
    // Updated to exactly 8 entries per page
    private int currentPage = 1;
    private int pageSize = 8; 

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        var data = await Database.GetEntriesAsync();
        AllEntries = data.OrderByDescending(e => e.Date).ToList();

        UniqueMoods = AllEntries
            .Where(e => !string.IsNullOrEmpty(e.PrimaryMood))
            .Select(e => e.PrimaryMood)
            .Distinct()
            .ToList();

        ApplyFilters();
    }

    private void ApplyFilters()
    {
        FilteredEntries = AllEntries
            .Where(e => (string.IsNullOrWhiteSpace(searchTerm) || 
                         (e.Title?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false) || 
                         (e.Content?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false)) &&
                        (string.IsNullOrEmpty(selectedMood) || e.PrimaryMood == selectedMood))
            .ToList();

        if (currentPage > TotalPages && TotalPages > 0) currentPage = 1;
    }

    private IEnumerable<JournalEntry> PaginatedEntries => 
        FilteredEntries.Skip((currentPage - 1) * pageSize).Take(pageSize);

    private int TotalPages => (int)Math.Ceiling((double)FilteredEntries.Count / pageSize);

    private void NextPage() { if (currentPage < TotalPages) currentPage++; }
    private void PrevPage() { if (currentPage > 1) currentPage--; }

    private void OnMoodFilterChanged(ChangeEventArgs e)
    {
        selectedMood = e.Value?.ToString() ?? "";
        currentPage = 1; 
        ApplyFilters();
    }

    private void ResetFilters()
    {
        searchTerm = "";
        selectedMood = "";
        currentPage = 1;
        ApplyFilters();
    }

    private void ViewEntry(JournalEntry entry)
    {
        Nav.NavigateTo($"/journal/view/{entry.Date:yyyy-MM-dd}");
    }

    private string StripHtml(string html)
    {
        if (string.IsNullOrEmpty(html)) return "";
        return System.Text.RegularExpressions.Regex.Replace(html, "<.*?>", string.Empty);
    }
}