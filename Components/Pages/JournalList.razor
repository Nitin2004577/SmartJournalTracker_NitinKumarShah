@page "/journals"
@using smart_journal.Models
@using smart_journal.Data
@inject AppDatabase Database
@inject NavigationManager Nav

<div class="container-fluid p-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold m-0 text-dark">Journal History</h2>
        <span class="badge bg-primary px-3 py-2 shadow-sm">Total: @FilteredEntries.Count Entries</span>
    </div>

    @* --- SEARCH & FILTER BAR --- *@
    <div class="card shadow-sm border-0 mb-4 bg-white rounded-3">
        <div class="card-body p-3">
            <div class="row g-3">
                <div class="col-12 col-lg-5">
                    <div class="input-group">
                        <span class="input-group-text bg-light border-end-0 text-muted">🔍</span>
                        <input type="text" class="form-control border-start-0 bg-light" 
                               placeholder="Search title, content, or #tags..." 
                               @bind="searchTerm" @bind:event="oninput" @onkeyup="ApplyFilters" />
                    </div>
                </div>
                <div class="col-6 col-lg-3">
                    <select class="form-select bg-light" @onchange="OnMoodFilterChanged">
                        <option value="">All Moods</option>
                        @foreach (var mood in UniqueMoods)
                        {
                            <option value="@mood">@mood</option>
                        }
                    </select>
                </div>
                <div class="col-6 col-lg-2">
                    <select class="form-select bg-light" @onchange="OnPageSizeChanged">
                        <option value="5">5 per page</option>
                        <option value="10" selected>10 per page</option>
                        <option value="25">25 per page</option>
                    </select>
                </div>
                <div class="col-12 col-lg-2">
                    <button class="btn btn-outline-danger w-100" @onclick="ResetFilters">Reset</button>
                </div>
            </div>
        </div>
    </div>

    @* --- JOURNAL LIST --- *@
    <div class="row">
        @if (PaginatedEntries == null || !PaginatedEntries.Any())
        {
            <div class="col-12 text-center py-5">
                <div class="display-1 text-muted opacity-25">Empty</div>
                <p class="text-secondary mt-3">No entries found matching those criteria.</p>
                <button class="btn btn-primary mt-2" @onclick="ResetFilters">Clear Filters</button>
            </div>
        }
        else
        {
            @foreach (var entry in PaginatedEntries)
            {
                <div class="col-12 mb-3">
                    <div class="card h-100 shadow-sm border-0 journal-list-item" 
                         @onclick="() => ViewEntry(entry)">
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div>
                                    <h4 class="card-title fw-bold text-dark mb-1">@entry.Title</h4>
                                    <div class="text-muted small d-flex align-items-center">
                                        <span class="me-3">📅 @entry.Date.ToString("dddd, MMM dd, yyyy")</span>
                                        <span>🕒 @entry.Date.ToString("t")</span>
                                    </div>
                                </div>
                                <div class="text-end">
                                    <span class="badge rounded-pill bg-primary px-3 py-2 mb-1">@entry.PrimaryMood</span>
                                    <div class="small text-muted fw-bold">@entry.MoodCategory</div>
                                </div>
                            </div>
                            
                            <p class="card-text text-secondary mb-3 preview-text">
                                @((MarkupString)GetPreviewText(entry.Content))
                            </p>

                            <div class="d-flex flex-wrap gap-2">
                                @if (!string.IsNullOrEmpty(entry.Tags))
                                {
                                    @foreach (var tag in entry.Tags.Split(',', StringSplitOptions.RemoveEmptyEntries))
                                    {
                                        <span class="tag-badge">#@tag.Trim()</span>
                                    }
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }
        }
    </div>

    @* --- PAGINATION CONTROLS --- *@
    @if (TotalPages > 1)
    {
        <div class="d-flex justify-content-between align-items-center mt-4 bg-white p-3 rounded-pill shadow-sm">
            <button class="btn btn-dark rounded-pill px-4" 
                    disabled="@(currentPage == 1)" 
                    @onclick="PrevPage">❮ Previous</button>
            
            <span class="text-muted fw-bold">Page @currentPage of @TotalPages</span>
            
            <button class="btn btn-dark rounded-pill px-4" 
                    disabled="@(currentPage == TotalPages)" 
                    @onclick="NextPage">Next ❯</button>
        </div>
    }
</div>

<style>
    .journal-list-item {
        cursor: pointer;
        transition: all 0.3s ease;
        border-left: 0px solid #0d6efd;
    }

    .journal-list-item:hover {
        transform: scale(1.01);
        box-shadow: 0 10px 20px rgba(0,0,0,0.08) !important;
        border-left: 5px solid #0d6efd;
    }

    .preview-text {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        font-size: 0.95rem;
        line-height: 1.6;
    }

    .tag-badge {
        background-color: #f8f9fa;
        color: #6c757d;
        border: 1px solid #dee2e6;
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 600;
    }
</style>

@code {
    private List<JournalEntry> AllEntries = new();
    private List<JournalEntry> FilteredEntries = new();
    private List<string> UniqueMoods = new();
    
    private string searchTerm = "";
    private string selectedMood = "";
    private int currentPage = 1;
    private int pageSize = 10;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        var data = await Database.GetEntriesAsync();
        AllEntries = data.OrderByDescending(e => e.Date).ToList();
        
        UniqueMoods = AllEntries
            .Where(e => !string.IsNullOrEmpty(e.PrimaryMood))
            .Select(e => e.PrimaryMood)
            .Distinct()
            .ToList();

        ApplyFilters();
    }

    private void ApplyFilters()
    {
        FilteredEntries = AllEntries
            .Where(e => (string.IsNullOrWhiteSpace(searchTerm) || 
                         (e.Title?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false) || 
                         (e.Content?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false) ||
                         (e.Tags?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false)) &&
                        (string.IsNullOrEmpty(selectedMood) || e.PrimaryMood == selectedMood))
            .ToList();

        currentPage = 1; 
    }

    private IEnumerable<JournalEntry> PaginatedEntries => 
        FilteredEntries.Skip((currentPage - 1) * pageSize).Take(pageSize);

    private int TotalPages => (int)Math.Ceiling((double)FilteredEntries.Count / pageSize);

    private void OnMoodFilterChanged(ChangeEventArgs e)
    {
        selectedMood = e.Value?.ToString() ?? "";
        ApplyFilters();
    }

    private void OnPageSizeChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int result))
        {
            pageSize = result;
            currentPage = 1;
        }
    }

    private void NextPage() { if (currentPage < TotalPages) currentPage++; }
    private void PrevPage() { if (currentPage > 1) currentPage--; }
    
    private void ResetFilters()
    {
        searchTerm = "";
        selectedMood = "";
        ApplyFilters();
    }

    private string GetPreviewText(string content)
    {
        if (string.IsNullOrEmpty(content)) return "";
        // Simple HTML stripping for preview
        var plainText = System.Text.RegularExpressions.Regex.Replace(content, "<.*?>", string.Empty);
        return plainText.Length > 200 ? plainText.Substring(0, 200) + "..." : plainText;
    }

    private void ViewEntry(JournalEntry entry)
    {
        // Redirecting to your specific View Page format
        string dateParam = entry.Date.ToString("yyyy-MM-dd");
        Nav.NavigateTo($"/journal/view/{dateParam}");
    }
}