@page "/journals"
@using smart_journal.Models
@using smart_journal.Data
@using QuestPDF.Fluent
@using QuestPDF.Helpers
@using QuestPDF.Infrastructure
@using CommunityToolkit.Maui.Storage
@using System.IO
@inject AppDatabase Database
@inject NavigationManager Nav

<div class="container-fluid p-4">
    @* --- HEADER --- *@
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold m-0 theme-text">Journal History</h2>
        <div class="text-end">
            <span class="badge rounded-pill theme-badge">@FilteredEntries.Count Total</span>
        </div>
    </div>

    @* --- EXPORT SECTION (Date Range) --- *@
    <div class="card theme-card border-0 mb-4 rounded-3 shadow-sm">
        <div class="card-body p-3">
            <h6 class="fw-bold mb-3 theme-text">Export Journals to PDF</h6>
            <div class="row g-2 align-items-end">
                <div class="col-md-4">
                    <label class="small fw-bold theme-muted">From:</label>
                    <input type="date" class="form-control theme-input" @bind="StartDate" />
                </div>
                <div class="col-md-4">
                    <label class="small fw-bold theme-muted">To:</label>
                    <input type="date" class="form-control theme-input" @bind="EndDate" />
                </div>
                <div class="col-md-4">
                    <button class="btn btn-primary w-100" @onclick="ExportToPdf" disabled="@isExporting">
                        @if (isExporting)
                        {
                            <span class="spinner-border spinner-border-sm"></span>
                        }
                        else
                        {
                            <span>💾 Save PDF As...</span>
                        }
                    </button>
                </div>
            </div>
            @if (!string.IsNullOrEmpty(statusMessage))
            {
                <div class="small mt-2 fw-bold @(statusMessage.Contains("✅") ? "text-success" : "text-danger")">
                    @statusMessage
                </div>
            }
        </div>
    </div>

    @* --- SEARCH & FILTER SECTION --- *@
    <div class="card theme-card border-0 mb-4 rounded-3 shadow-sm">
        <div class="card-body p-3">
            <div class="row g-2">
                <div class="col-md-6">
                    <input type="text" class="form-control theme-input"
                           placeholder="Search your memories..."
                           @bind="searchTerm" @bind:event="oninput" @onkeyup="ApplyFilters" />
                </div>
                <div class="col-md-3">
                    <select class="form-select theme-input" @onchange="OnMoodFilterChanged">
                        <option value="">All Moods</option>
                        @foreach (var mood in UniqueMoods)
                        {
                            <option value="@mood">@mood</option>
                        }
                    </select>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-outline-secondary w-100 theme-btn-outline" @onclick="ResetFilters">Reset Filters</button>
                </div>
            </div>
        </div>
    </div>

    @* --- THE LIST --- *@
    <div class="journal-list-container">
        @if (!PaginatedEntries.Any())
        {
            <div class="text-center py-5 theme-card rounded shadow-sm">
                <p class="theme-muted mb-0">No entries found for this page or filter.</p>
            </div>
        }
        else
        {
            @foreach (var entry in PaginatedEntries)
            {
                <div class="card border-0 shadow-sm mb-3 journal-card theme-card" @onclick="() => ViewEntry(entry)">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h5 class="fw-bold theme-text mb-1">@entry.Title</h5>
                                <p class="theme-muted small mb-2">@entry.Date.ToString("MMMM dd, yyyy")</p>
                            </div>
                            <span class="badge theme-mood-badge">@entry.PrimaryMood</span>
                        </div>
                        <p class="theme-muted text-truncate">@StripHtml(entry.Content)</p>
                    </div>
                </div>
            }
        }
    </div>

    @* --- PAGINATION --- *@
    @if (TotalPages > 0)
    {
        <div class="d-flex justify-content-center align-items-center gap-4 mt-4">
            <button class="btn btn-theme-round" disabled="@(currentPage == 1)" @onclick="PrevPage">❮</button>
            <span class="fw-bold theme-text">Page @currentPage of @TotalPages</span>
            <button class="btn btn-theme-round" disabled="@(currentPage == TotalPages)" @onclick="NextPage">❯</button>
        </div>
    }
</div>

<style>
    /* Dark Mode Aware Styles */
    .theme-text {
        color: var(--text-primary);
    }

    .theme-muted {
        color: var(--text-muted);
    }

    .theme-card {
        background-color: var(--bg-card);
        color: var(--text-primary);
        border: 1px solid var(--border-color) !important;
    }

    .theme-input {
        background-color: var(--bg-main);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
    }

        .theme-input:focus {
            background-color: var(--bg-main);
            color: var(--text-primary);
            border-color: var(--primary-green);
            box-shadow: 0 0 0 0.25rem var(--accent-light);
        }

    .theme-badge {
        background-color: var(--primary-green);
        color: #fff;
    }

    .theme-mood-badge {
        background-color: var(--accent-light);
        color: var(--primary-green);
        border: 1px solid var(--primary-green);
    }

    .theme-btn-outline {
        color: var(--text-muted);
        border-color: var(--border-color);
    }

        .theme-btn-outline:hover {
            background-color: var(--accent-light);
            color: var(--primary-green);
        }

    .journal-card {
        cursor: pointer;
        transition: all 0.2s ease;
        border-left: 5px solid transparent !important;
    }

        .journal-card:hover {
            transform: translateX(8px);
            border-left: 5px solid var(--primary-green) !important;
            background-color: var(--accent-light);
        }

    .btn-theme-round {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: var(--bg-card);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        justify-content: center;
    }

        .btn-theme-round:disabled {
            opacity: 0.4;
        }

        .btn-theme-round:hover:not(:disabled) {
            background-color: var(--primary-green);
            color: white;
        }

    .text-truncate {
        display: -webkit-box;
        -webkit-line-clamp: 1;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
</style>

@code {
    private List<JournalEntry> AllEntries = new();
    private List<JournalEntry> FilteredEntries = new();
    private List<string> UniqueMoods = new();
    private string searchTerm = "";
    private string selectedMood = "";
    private int currentPage = 1;
    private int pageSize = 8;

    private DateTime StartDate { get; set; } = DateTime.Today.AddMonths(-1);
    private DateTime EndDate { get; set; } = DateTime.Today;
    private bool isExporting = false;
    private string statusMessage = "";

    protected override async Task OnInitializedAsync()
    {
        QuestPDF.Settings.License = LicenseType.Community;
        await LoadData();
    }

    private async Task LoadData()
    {
        var data = await Database.GetEntriesAsync();
        AllEntries = data.OrderByDescending(e => e.Date).ToList();
        UniqueMoods = AllEntries.Where(e => !string.IsNullOrEmpty(e.PrimaryMood)).Select(e => e.PrimaryMood).Distinct().ToList();
        ApplyFilters();
    }

    private void ApplyFilters()
    {
        FilteredEntries = AllEntries
            .Where(e => (string.IsNullOrWhiteSpace(searchTerm) ||
                         (e.Title?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false) ||
                         (e.Content?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false)) &&
                        (string.IsNullOrEmpty(selectedMood) || e.PrimaryMood == selectedMood))
            .ToList();
        if (currentPage > TotalPages && TotalPages > 0) currentPage = 1;
    }

    private async Task ExportToPdf()
    {
        if (isExporting) return;
        isExporting = true;
        statusMessage = "";

        try
        {
            var entriesToExport = AllEntries
                .Where(e => e.Date.Date >= StartDate.Date && e.Date.Date <= EndDate.Date)
                .OrderBy(e => e.Date)
                .ToList();

            if (!entriesToExport.Any()) { statusMessage = "⚠️ No entries found in range."; return; }

            var document = Document.Create(container =>
            {
                container.Page(page =>
                {
                    page.Margin(40);
                    page.Header().PaddingBottom(20).Text("My Journal History").FontSize(28).Bold().FontColor("#2d6a4f");
                    page.Content().Column(col =>
                    {
                        foreach (var entry in entriesToExport)
                        {
                            col.Item().PaddingBottom(20).Decoration(dec =>
                            {
                                dec.Content().Border(1).BorderColor("#d8f3dc").Padding(15).Column(eCol =>
                                {
                                    eCol.Item().Row(row =>
                                    {
                                        row.RelativeItem().Column(d =>
                                        {
                                            d.Item().Text(entry.Date.Day.ToString()).FontSize(22).Bold();
                                            d.Item().Text($"{entry.Date:MMMM yyyy}").FontSize(10).FontColor("#64748b");
                                        });
                                        row.RelativeItem().AlignRight().Text(entry.PrimaryMood).Italic().FontColor("#2d6a4f");
                                    });
                                    eCol.Item().PaddingVertical(8).LineHorizontal(0.5f).LineColor("#d8f3dc");
                                    eCol.Item().PaddingBottom(5).Text(entry.Title).FontSize(16).Bold();
                                    eCol.Item().Text(StripHtml(entry.Content)).FontSize(11).LineHeight(1.4f);
                                });
                            });
                        }
                    });
                });
            });

            using var stream = new MemoryStream(document.GeneratePdf());
            var fileName = $"Journal_Export_{DateTime.Now:yyyyMMdd}.pdf";
            var result = await FileSaver.Default.SaveAsync(fileName, stream, default);
            if (result.IsSuccessful) statusMessage = "✅ PDF Saved Successfully!";
        }
        catch (Exception ex) { statusMessage = "❌ Error: " + ex.Message; }
        finally { isExporting = false; StateHasChanged(); }
    }

    private IEnumerable<JournalEntry> PaginatedEntries => FilteredEntries.Skip((currentPage - 1) * pageSize).Take(pageSize);
    private int TotalPages => (int)Math.Ceiling((double)FilteredEntries.Count / pageSize);
    private void NextPage() { if (currentPage < TotalPages) currentPage++; }
    private void PrevPage() { if (currentPage > 1) currentPage--; }
    private void OnMoodFilterChanged(ChangeEventArgs e) { selectedMood = e.Value?.ToString() ?? ""; currentPage = 1; ApplyFilters(); }
    private void ResetFilters() { searchTerm = ""; selectedMood = ""; currentPage = 1; ApplyFilters(); }
    private void ViewEntry(JournalEntry entry) => Nav.NavigateTo($"/journal/view/{entry.Date:yyyy-MM-dd}");

    private string StripHtml(string html)
    {
        if (string.IsNullOrEmpty(html)) return "";
        var formatted = System.Text.RegularExpressions.Regex.Replace(html, "<(p|br|li|div).*?>", " ", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        return System.Net.WebUtility.HtmlDecode(System.Text.RegularExpressions.Regex.Replace(formatted, "<.*?>", string.Empty)).Trim();
    }
}